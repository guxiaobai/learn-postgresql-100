# 第 4 章 psql 工具的使用介绍

|本期版本|上期版本
|:---:|:---:
`Thu Jul 20 23:18:47 CST 2023 | -

## 4.2 psql 的简单使用

* 为什么不需要输入用户名和密码: 建立一个与用户同名的数据库
* **psql 的命令都是以斜杠 `\` 开头的**
* **使用 `psql -l` 可以查看有哪些数据库**
* 默认会有一个叫 `postgres` 的数据库，还有两个模版数据 `template0` 和 `template1`
* 当用户在建数据时，默认是从模版数据库 `template1` 克隆出来的



命令|说明
---|---
`\l` | 查看数据库
`\c` | 连接到数据库



## 4.3 psql 的常用命令


### 4.3.1 \d 命令

```
\d [ pattern ]
\d [ pattern ] +
```

* 1）如果 `\d` 命令什么都不带，将列出当前数据库中的所有表
* 2）`\d` 后面跟一个表名，表示显示这个表的结构定义
* 3）`\d t_pkey` 可以显示索引信息
* 4) `\d` 后面也可以跟一通配符如 `*` 或 `?`
* 5）`\d+` 将显示比 `\d` 更详细的信息
* 6）匹配不同对象类型的 `\d` 命令
	* 表: `\dt`
	* 索引: `\di`
	* 序列: `\ds`
	* 视图: `\dv`
	* 函数: `\df`
* 7）显示 SQL 已执行的时间，可以用`\timing on`
* 8）列出所有的 schema 可以使用 `\dn` 命令
* 9）显示所有的表空间可以用 `\db` 命令
	* 表空间就是对应一个目录
* 10）想要列出数据库中的所有角色或用户,可以使用 `\du` 或 `\dg` 命令
	* `\du` 和 `\dg` 命令等价。原因是用户和角色不分的
* 11) `\dp` 或 `\z` 命令用于显示表的权限分配情况

### 4.3.4 `\x` 命令

* 使用 `\x` 命令，可以把表中每一行的每列数据都拆分为单行展示

### 4.3.5 执行存储在外部文件中的SQL命令

* 命令 `\i <filename>` 执行存储在外部文件中的 sql 语句或命令
* 当然也可以在 psql 命令行加 `-s <filename>` 来执行 SQL脚本文件中的命令


### 4.3.6 显示信息的命令

* `\echo` 命令用于输出一行信息

### 4.3.7 更多命令

* 更多的命令可以用 `\?` 来显示

## 4.4 psql的使用技巧和注意事项

### 4.4.1 历史命令与补全的功能

* 可以使用上下键把以前使用过的命令或SQL语句调出来，连续按两个 tab 键表示把命令补全或给出提示输入 

### 4.4.2 自动提交方面的技巧

* 在 psql 中事务是自动提交的
* 方法一: 运行 `begin;`命令，然后执行 dml 语句， 最后再执行 `commit` 或  `rollback` 语句
* 方法二: 直接使用 psql 中的命令关闭自动提交的功能
	* `\set AUTOCOMMIT off`

### 4.4.3 如何得到 psql 中命令实际执行的 SQL

* 如果在启动 psql 的命令行中加 `-E` 参数，就可以把 psql 中各种以 `\` 开头的命令执行的实际SQL打印出来
* 如果想在已运行的 psql 中显示某一个命令实际执行的SQL，但是显示完后又想关闭下这个功能。
	* `\set ECHO_HIDDEN on | off`


